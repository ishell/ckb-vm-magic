# ç¬¬äºŒç« ï¼šæŠ€æœ¯é€‰å‹ - ä¸ºä»€ä¹ˆé€‰æ‹© RISC-V å’Œ Rustï¼Ÿ

> ä»æ¶æ„è®¾è®¡åˆ°ç¼–ç¨‹è¯­è¨€çš„å®Œæ•´æŠ€æœ¯å†³ç­–åˆ†æ

---

## ğŸ“– æœ¬ç« å¯¼èˆª

- [RISC-Vï¼šå¼€æºçš„æŒ‡ä»¤é›†é©å‘½](#risc-vå¼€æºçš„æŒ‡ä»¤é›†é©å‘½)
- [Rustï¼šç³»ç»Ÿç¼–ç¨‹çš„æ–°èŒƒå¼](#rustç³»ç»Ÿç¼–ç¨‹çš„æ–°èŒƒå¼)
- [æŠ€æœ¯é€‰å‹æ€»ç»“ï¼šé»„é‡‘ç»„åˆçš„è¯ç”Ÿ](#æŠ€æœ¯é€‰å‹æ€»ç»“é»„é‡‘ç»„åˆçš„è¯ç”Ÿ)

---

## ğŸ—ï¸ RISC-Vï¼šå¼€æºçš„æŒ‡ä»¤é›†é©å‘½

### ä»€ä¹ˆæ˜¯æŒ‡ä»¤é›†æ¶æ„ï¼ˆISAï¼‰ï¼Ÿ

**ç±»æ¯”**ï¼šæŒ‡ä»¤é›†å°±åƒä¸€é—¨è¯­è¨€çš„"åŸºç¡€è¯æ±‡è¡¨"

```
äººç±»è¯­è¨€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯æ±‡ï¼šåƒã€è·‘ã€è·³ã€æ€è€ƒ...        â”‚
â”‚ è¯­æ³•ï¼šä¸»è°“å®¾ã€æ—¶æ€ã€è¯­æ°”...      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¡ç®—æœºæŒ‡ä»¤é›†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡ä»¤ï¼šADDï¼ˆåŠ ï¼‰ã€SUBï¼ˆå‡ï¼‰ã€      â”‚
â”‚       LOADï¼ˆè¯»å†…å­˜ï¼‰ã€JUMPï¼ˆè·³è½¬ï¼‰â”‚
â”‚ æ ¼å¼ï¼šæ“ä½œç  + æ“ä½œæ•°            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŒ‡ä»¤é›†å®šä¹‰äº†**ï¼š
- CPU èƒ½åšä»€ä¹ˆæ“ä½œï¼ˆæŒ‡ä»¤åˆ—è¡¨ï¼‰
- æŒ‡ä»¤å¦‚ä½•ç¼–ç ï¼ˆäºŒè¿›åˆ¶æ ¼å¼ï¼‰
- æ•°æ®å¦‚ä½•å­˜å‚¨ï¼ˆå­—èŠ‚åºã€å¯¹é½ï¼‰
- å¼‚å¸¸å¦‚ä½•å¤„ç†ï¼ˆä¸­æ–­ã€é™·é˜±ï¼‰

---

### ä¸‰å¤§æŒ‡ä»¤é›†å¯¹æ¯”

#### å¯¹æ¯”è¡¨ï¼ˆè¯¦ç»†ç‰ˆï¼‰

| ç»´åº¦ | x86 (Intel/AMD) | ARM | RISC-V |
|------|----------------|-----|---------|
| **å¼€æ”¾æ€§** | âŒ ä¸“åˆ©å°é—­<br/>éœ€æˆæƒè´¹ | âš ï¸ éœ€è¦æˆæƒ<br/>è´¹ç”¨æ˜‚è´µ | âœ… **å®Œå…¨å¼€æº**<br/>å…è´¹ä½¿ç”¨ |
| **å¤æ‚åº¦** | ğŸ˜± **æå…¶å¤æ‚**<br/>1000+ æ¡æŒ‡ä»¤<br/>å¯å˜é•¿åº¦ï¼ˆ1-15 å­—èŠ‚ï¼‰ | ğŸ˜ ä¸­ç­‰å¤æ‚<br/>~200 æ¡æŒ‡ä»¤<br/>å›ºå®š/å¯å˜é•¿åº¦ | ğŸ˜Š **ç®€æ´ä¼˜é›…**<br/>åŸºç¡€ 47 æ¡æŒ‡ä»¤<br/>å›ºå®š 32 ä½ |
| **æ–‡æ¡£** | ğŸ“š 5000+ é¡µ<br/>å†å²åŒ…è¢±é‡ | ğŸ“š å®Œå–„ä½†éœ€æˆæƒ | ğŸ“– **200 é¡µæ¸…æ™°è§„èŒƒ**<br/>å…è´¹å…¬å¼€ |
| **æ‰©å±•æ€§** | âš ï¸ å›°éš¾<br/>SSE/AVX æ··ä¹± | ğŸ˜ æœ‰é™<br/>ç‰ˆæœ¬ç¢ç‰‡åŒ– | âœ… **æ¨¡å—åŒ–è®¾è®¡**<br/>I+M+A+C+B... |
| **è™šæ‹ŸåŒ–** | ğŸ˜ éœ€ç‰¹æ®Šå¤„ç†<br/>VT-x/AMD-V | ğŸ˜ éœ€ Hypervisor | âœ… **å¤©ç”Ÿå‹å¥½**<br/>ç®€å•æŒ‡ä»¤æ˜“æ¨¡æ‹Ÿ |
| **åŠŸè€—** | ğŸ˜¡ é«˜åŠŸè€—<br/>å¤æ‚è§£ç å™¨ | ğŸ˜Š ä½åŠŸè€— | âœ… **æä½åŠŸè€—**<br/>ç®€å•ç¡¬ä»¶ |
| **ç¡®å®šæ€§** | âš ï¸ å¾®ç æ›´æ–°<br/>æœªå…¬å¼€è¡Œä¸º | ğŸ˜ éƒ¨åˆ†å…¬å¼€ | âœ… **å®Œå…¨ç¡®å®š**<br/>è§„èŒƒä¸¥æ ¼å®šä¹‰ |

#### ä¸“å®¶è§†è§’ï¼šä¸ºä»€ä¹ˆ x86 å¦‚æ­¤å¤æ‚ï¼Ÿ

**å†å²åŒ…è¢±çš„æ¼”åŒ–**ï¼š

```
1978: 8086 (16ä½)
  â””â”€> æŒ‡ä»¤é›†ï¼š~100 æ¡

1985: 80386 (32ä½)
  â””â”€> å‘åå…¼å®¹ 8086
  â””â”€> æŒ‡ä»¤é›†ï¼š~200 æ¡

1995: Pentium (MMX)
  â””â”€> å‘åå…¼å®¹ 386
  â””â”€> æ–°å¢ MMX æŒ‡ä»¤
  â””â”€> æŒ‡ä»¤é›†ï¼š~300 æ¡

2000: Pentium 4 (SSE2)
  â””â”€> å‘åå…¼å®¹æ‰€æœ‰å‰ä»£
  â””â”€> æ–°å¢ SSE/SSE2
  â””â”€> æŒ‡ä»¤é›†ï¼š~500 æ¡

2011: Sandy Bridge (AVX)
  â””â”€> å‘åå…¼å®¹æ‰€æœ‰å‰ä»£
  â””â”€> æ–°å¢ AVX
  â””â”€> æŒ‡ä»¤é›†ï¼š~800 æ¡

2023: ç°ä»£ x86
  â””â”€> å‘åå…¼å®¹æ‰€æœ‰å‰ä»£ï¼ˆ45 å¹´å†å²ï¼ï¼‰
  â””â”€> æ–°å¢ AVX-512ã€SGX ç­‰
  â””â”€> æŒ‡ä»¤é›†ï¼š1000+ æ¡ ğŸ˜±
```

**åæœ**ï¼š
- ğŸ“š æŒ‡ä»¤æ‰‹å†Œ 5000+ é¡µ
- ğŸ’° èŠ¯ç‰‡é¢ç§¯ 30% ç”¨äºè§£ç å™¨
- ğŸ› å¤æ‚æ€§å¯¼è‡´å®‰å…¨æ¼æ´ï¼ˆSpectreã€Meltdownï¼‰
- â±ï¸ è®¾è®¡éªŒè¯éœ€è¦æ•°å¹´

---

### RISC-V çš„æ¨¡å—åŒ–è®¾è®¡

#### æŒ‡ä»¤é›†æ‰©å±•ç»“æ„

```mermaid
graph TB
    subgraph "RISC-V æŒ‡ä»¤é›†æ¶æ„"
        Base[RV64I: åŸºç¡€æ•´æ•°æŒ‡ä»¤ 47æ¡]

        Base --> M[Mæ‰©å±•: ä¹˜æ³•é™¤æ³• 8æ¡]
        Base --> A[Aæ‰©å±•: åŸå­æ“ä½œ 11æ¡]
        Base --> F[Fæ‰©å±•: å•ç²¾åº¦æµ®ç‚¹ 26æ¡]
        Base --> D[Dæ‰©å±•: åŒç²¾åº¦æµ®ç‚¹ 26æ¡]
        Base --> C[Cæ‰©å±•: å‹ç¼©æŒ‡ä»¤ 16ä½]
        Base --> B[Bæ‰©å±•: ä½æ“ä½œ 43æ¡]
        Base --> V[Væ‰©å±•: å‘é‡ SIMD]

        M --> IMAC[ç»„åˆ: RV64IMAC]
        A --> IMAC
        C --> IMAC

        IMAC --> CKB[CKB-VMé€‰æ‹©: RV64IMCB]
        B --> CKB
    end

    style Base fill:#f96,stroke:#333,stroke-width:3px
    style CKB fill:#6f9,stroke:#333,stroke-width:3px
```

**CKB-VM çš„é€‰æ‹©**ï¼š`RV64IMCB`

- **I** (Integer)ï¼šåŸºç¡€æ•´æ•°è¿ç®— - å¿…éœ€
- **M** (Multiply)ï¼šä¹˜æ³•é™¤æ³• - å¯†ç å­¦éœ€è¦
- **C** (Compressed)ï¼š16 ä½å‹ç¼©æŒ‡ä»¤ - èŠ‚çœå†…å­˜
- **B** (Bit Manipulation)ï¼šä½æ“ä½œ - ä¼˜åŒ–æ€§èƒ½

**ä¸ºä»€ä¹ˆä¸é€‰ F/Dï¼ˆæµ®ç‚¹ï¼‰ï¼Ÿ**
- âŒ æµ®ç‚¹è¿ç®—ä¸ç¡®å®šï¼ˆèˆå…¥æ¨¡å¼ï¼‰
- âŒ åŒºå—é“¾ä¸éœ€è¦æµ®ç‚¹ï¼ˆæ•´æ•°å³å¯ï¼‰
- âœ… å»æ‰åæŒ‡ä»¤é›†æ›´ç®€æ´

---

### RISC-V æŒ‡ä»¤æ ¼å¼è¯¦è§£

#### å…­ç§æŒ‡ä»¤æ ¼å¼

```
1. R-Type (å¯„å­˜å™¨-å¯„å­˜å™¨æ“ä½œ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ funct7  â”‚  rs2  â”‚  rs1  â”‚funct3â”‚  rd   â”‚ opcode â”‚
â”‚  7ä½    â”‚  5ä½  â”‚  5ä½  â”‚ 3ä½  â”‚  5ä½  â”‚  7ä½   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
31      25 24   20 19   15 14  12 11    7 6      0

ç¤ºä¾‹ï¼šadd rd, rs1, rs2  (rd = rs1 + rs2)


2. I-Type (ç«‹å³æ•°æ“ä½œ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   immediate     â”‚  rs1  â”‚funct3â”‚  rd   â”‚ opcode â”‚
â”‚    12ä½         â”‚  5ä½  â”‚ 3ä½  â”‚  5ä½  â”‚  7ä½   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
31            20 19   15 14  12 11    7 6      0

ç¤ºä¾‹ï¼šaddi rd, rs1, 42  (rd = rs1 + 42)


3. S-Type (å­˜å‚¨æ“ä½œ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ imm[11:5â”‚  rs2  â”‚  rs1  â”‚funct3â”‚imm[4:0] â”‚ opcode â”‚
â”‚  7ä½    â”‚  5ä½  â”‚  5ä½  â”‚ 3ä½  â”‚  5ä½    â”‚  7ä½   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
31      25 24   20 19   15 14  12 11      7 6      0

ç¤ºä¾‹ï¼šsd rs2, offset(rs1)  (å­˜å‚¨ rs2 åˆ°å†…å­˜)


4. B-Type (åˆ†æ”¯æ“ä½œ)
â”Œâ”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚12â”‚[10:5]â”‚  rs2  â”‚  rs1  â”‚funct3â”‚[4:1] â”‚11â”‚ opcode â”‚
â””â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç¤ºä¾‹ï¼šbeq rs1, rs2, label  (å¦‚æœç›¸ç­‰åˆ™è·³è½¬)


5. U-Type (å¤§ç«‹å³æ•°)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     immediate[31:12]       â”‚  rd   â”‚ opcode â”‚
â”‚         20ä½               â”‚  5ä½  â”‚  7ä½   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç¤ºä¾‹ï¼šlui rd, 0x12345  (åŠ è½½é«˜ä½ç«‹å³æ•°)


6. J-Type (è·³è½¬)
â”Œâ”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚20â”‚ [10:1]   â”‚11â”‚[19:12â”‚  rd   â”‚ opcode â”‚
â””â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç¤ºä¾‹ï¼šjal rd, label  (è·³è½¬å¹¶é“¾æ¥)
```

**æ ¼å¼è®¾è®¡çš„ç²¾å¦™ä¹‹å¤„**ï¼š
- ğŸ“ å›ºå®š 32 ä½é•¿åº¦ â†’ è§£ç ç®€å•
- ğŸ¯ rs1/rs2/rd ä½ç½®å›ºå®š â†’ å¹¶è¡Œè¯»å–å¯„å­˜å™¨
- ğŸ”¢ ç«‹å³æ•°ç¬¦å·æ‰©å±• â†’ ç»Ÿä¸€å¤„ç†
- ğŸ’¡ æ“ä½œç åœ¨ä½ä½ â†’ å¿«é€Ÿè¯†åˆ«

---

### çœŸå®æ¡ˆä¾‹ï¼šåŠ æ³•æŒ‡ä»¤çš„ä¸‰ç§å®ç°

#### åœºæ™¯ï¼šè®¡ç®— `c = a + b`

**x86 æ±‡ç¼–ï¼ˆå¤æ‚ï¼‰**ï¼š

```asm
; C ä»£ç : int add(int a, int b) { return a + b; }

; x86-64 ç¼–è¯‘ç»“æœï¼ˆGCC -O2ï¼‰
add:
    push    rbp              ; ä¿å­˜æ ˆå¸§
    mov     rbp, rsp         ; è®¾ç½®æ ˆå¸§
    mov     DWORD PTR [rbp-4], edi   ; å‚æ•° a
    mov     DWORD PTR [rbp-8], esi   ; å‚æ•° b
    mov     edx, DWORD PTR [rbp-4]   ; è¯»å– a
    mov     eax, DWORD PTR [rbp-8]   ; è¯»å– b
    add     eax, edx         ; çœŸæ­£çš„åŠ æ³•ï¼
    pop     rbp              ; æ¢å¤æ ˆå¸§
    ret                      ; è¿”å›

; æŒ‡ä»¤æ•°ï¼š8 æ¡ï¼ˆä¸ºäº†ä¸€ä¸ªåŠ æ³•ï¼ï¼‰
; å­—èŠ‚æ•°ï¼š~20 å­—èŠ‚ï¼ˆå¯å˜é•¿åº¦ï¼‰
```

**ARM æ±‡ç¼–ï¼ˆä¸­ç­‰ï¼‰**ï¼š

```asm
; ARM Cortex-A (ARMv8)
add:
    add     w0, w0, w1      ; w0 = w0 + w1
    ret                     ; è¿”å›

; æŒ‡ä»¤æ•°ï¼š2 æ¡
; å­—èŠ‚æ•°ï¼š8 å­—èŠ‚ï¼ˆå›ºå®š 4 å­—èŠ‚/æŒ‡ä»¤ï¼‰
```

**RISC-V æ±‡ç¼–ï¼ˆç®€æ´ï¼‰**ï¼š

```asm
; RISC-V RV64I
add:
    add     a0, a0, a1      ; a0 = a0 + a1
    ret                     ; è¿”å›

; æŒ‡ä»¤æ•°ï¼š2 æ¡
; å­—èŠ‚æ•°ï¼š8 å­—èŠ‚ï¼ˆå›ºå®š 4 å­—èŠ‚/æŒ‡ä»¤ï¼‰

; æŒ‡ä»¤ç¼–ç ï¼ˆäºŒè¿›åˆ¶ï¼‰ï¼š
; add a0, a0, a1
; 0000000 01011 01010 000 01010 0110011
; â”‚       â”‚     â”‚     â”‚   â”‚     â””â”€ opcode (0x33 = R-type)
; â”‚       â”‚     â”‚     â”‚   â””â”€ rd = a0 (x10)
; â”‚       â”‚     â”‚     â””â”€ funct3 (0x0 = ADD)
; â”‚       â”‚     â””â”€ rs1 = a0 (x10)
; â”‚       â””â”€ rs2 = a1 (x11)
; â””â”€ funct7 (0x00 = ADD not SUB)
```

**å¯¹æ¯”æ€»ç»“**ï¼š

| æŒ‡æ ‡ | x86 | ARM | RISC-V |
|------|-----|-----|---------|
| æŒ‡ä»¤æ•° | 8 | 2 | 2 |
| å­—èŠ‚æ•° | ~20 | 8 | 8 |
| æ˜“ç†è§£åº¦ | ğŸ˜° | ğŸ˜Š | ğŸ˜Š |
| è™šæ‹ŸåŒ–éš¾åº¦ | ğŸ˜± é«˜ | ğŸ˜ ä¸­ | ğŸ˜Š ä½ |

---

### å®Œæ•´ç¤ºä¾‹ï¼šæ–æ³¢é‚£å¥‘æ•°åˆ—

#### C è¯­è¨€ç‰ˆæœ¬

```c
// è®¡ç®—ç¬¬ n ä¸ªæ–æ³¢é‚£å¥‘æ•°ï¼ˆé€’å½’ï¼‰
int fibonacci(int n) {
    if (n <= 1) {
        return n;
    }
    return fibonacci(n - 1) + fibonacci(n - 2);
}
```

#### RISC-V æ±‡ç¼–å®ç°

```asm
# fibonacci.s - RISC-V æ±‡ç¼–å®ç°
# è¾“å…¥ï¼ša0 = n
# è¾“å‡ºï¼ša0 = fib(n)

.globl fibonacci
fibonacci:
    # åŸºç¡€æƒ…å†µï¼šn <= 1
    li      t0, 1           # t0 = 1
    ble     a0, t0, base_case   # if (n <= 1) goto base_case

    # é€’å½’æƒ…å†µï¼šä¿å­˜å¯„å­˜å™¨
    addi    sp, sp, -16     # åˆ†é…æ ˆç©ºé—´
    sd      ra, 8(sp)       # ä¿å­˜è¿”å›åœ°å€
    sd      s0, 0(sp)       # ä¿å­˜ s0

    mv      s0, a0          # s0 = n (ä¿å­˜åŸå§‹ n)

    # è®¡ç®— fib(n-1)
    addi    a0, s0, -1      # a0 = n - 1
    call    fibonacci       # é€’å½’è°ƒç”¨
    mv      t1, a0          # t1 = fib(n-1)

    # è®¡ç®— fib(n-2)
    addi    a0, s0, -2      # a0 = n - 2
    call    fibonacci       # é€’å½’è°ƒç”¨

    # ç»“æœç›¸åŠ 
    add     a0, a0, t1      # a0 = fib(n-2) + fib(n-1)

    # æ¢å¤å¯„å­˜å™¨
    ld      s0, 0(sp)       # æ¢å¤ s0
    ld      ra, 8(sp)       # æ¢å¤è¿”å›åœ°å€
    addi    sp, sp, 16      # é‡Šæ”¾æ ˆç©ºé—´
    ret

base_case:
    # n <= 1ï¼Œç›´æ¥è¿”å› n
    ret

# æŒ‡ä»¤ç»Ÿè®¡ï¼š
# - æ€»å…± 17 æ¡æŒ‡ä»¤
# - æ¯æ¡ 4 å­—èŠ‚ï¼Œæ€»å…± 68 å­—èŠ‚
# - æ¸…æ™°æ˜“æ‡‚ï¼Œæ˜“äºä¼˜åŒ–
```

#### æŒ‡ä»¤æ‰§è¡Œæµç¨‹å¯è§†åŒ–

```
è°ƒç”¨ fibonacci(5)ï¼š

fibonacci(5)
 â”œâ”€> fibonacci(4)
 â”‚    â”œâ”€> fibonacci(3)
 â”‚    â”‚    â”œâ”€> fibonacci(2)
 â”‚    â”‚    â”‚    â”œâ”€> fibonacci(1) â†’ 1
 â”‚    â”‚    â”‚    â””â”€> fibonacci(0) â†’ 0
 â”‚    â”‚    â”‚    ç»“æœï¼š1
 â”‚    â”‚    â””â”€> fibonacci(1) â†’ 1
 â”‚    â”‚    ç»“æœï¼š2
 â”‚    â””â”€> fibonacci(2)
 â”‚         â”œâ”€> fibonacci(1) â†’ 1
 â”‚         â””â”€> fibonacci(0) â†’ 0
 â”‚         ç»“æœï¼š1
 â”‚    ç»“æœï¼š3
 â””â”€> fibonacci(3)
      â”œâ”€> fibonacci(2)
      â”‚    â”œâ”€> fibonacci(1) â†’ 1
      â”‚    â””â”€> fibonacci(0) â†’ 0
      â”‚    ç»“æœï¼š1
      â””â”€> fibonacci(1) â†’ 1
      ç»“æœï¼š2
ç»“æœï¼š5

æ ˆçš„å˜åŒ–ï¼š
[è°ƒç”¨ fib(5)]
  sp: 0x1000
  ä¿å­˜ ra, s0
  sp: 0x0FF0 â”€â”€â”
  [è°ƒç”¨ fib(4)]  â”‚
    sp: 0x0FE0   â”‚
    [è°ƒç”¨ fib(3)] â”‚
      sp: 0x0FD0  â”‚
      ...         â”‚
    [è¿”å› fib(3)] â”‚
  [è¿”å› fib(4)]   â”‚
sp: 0x1000 <â”€â”€â”€â”€â”€â”€â”˜
```

---

### ä¸“å®¶è§†è§’ï¼šRISC-V çš„è®¾è®¡å“²å­¦

#### è®¾è®¡åŸåˆ™

1. **ç®€å•æ€§ï¼ˆSimplicityï¼‰**
   ```
   "Make the common case fast, the uncommon case correct"
   ```
   - åŸºç¡€æŒ‡ä»¤é›†åªæœ‰ 47 æ¡
   - å›ºå®šé•¿åº¦æŒ‡ä»¤ï¼ˆæ˜“è§£ç ï¼‰
   - æ— éšå¼æ“ä½œï¼ˆæ˜¾å¼å³æ–‡æ¡£ï¼‰

2. **æ¨¡å—åŒ–ï¼ˆModularityï¼‰**
   ```
   Base ISA (I) + å¯é€‰æ‰©å±• (M/A/F/D/C...)
   ```
   - è‡ªç”±ç»„åˆæ‰€éœ€åŠŸèƒ½
   - é¿å…æŒ‡ä»¤é›†è†¨èƒ€
   - é™ä½å®ç°æˆæœ¬

3. **å¼€æ”¾æ€§ï¼ˆOpennessï¼‰**
   ```
   BSD å¼€æºè®¸å¯ + æ— ä¸“åˆ©å£å’
   ```
   - ä»»ä½•äººéƒ½èƒ½å®ç°
   - ç¤¾åŒºé©±åŠ¨å‘å±•
   - é¿å…ä¾›åº”å•†é”å®š

4. **å¯æ‰©å±•æ€§ï¼ˆExtensibilityï¼‰**
   ```
   è‡ªå®šä¹‰æŒ‡ä»¤ç©ºé—´ + æ ‡å‡†æ‰©å±•
   ```
   - æ”¯æŒç‰¹å®šé¢†åŸŸä¼˜åŒ–
   - ä¿æŒå…¼å®¹æ€§
   - é¼“åŠ±åˆ›æ–°

#### ä¸ x86/ARM çš„æ¶æ„å·®å¼‚

**å“²å­¦å¯¹æ¯”è¡¨**ï¼š

| ç»´åº¦ | x86 | ARM | RISC-V |
|------|-----|-----|---------|
| **è®¾è®¡ç›®æ ‡** | å‘åå…¼å®¹<br/>ï¼ˆ45 å¹´å†å²ï¼‰ | å¸‚åœºä»½é¢<br/>ï¼ˆç§»åŠ¨ä¼˜å…ˆï¼‰ | ç®€æ´å¼€æ”¾<br/>ï¼ˆæœªæ¥å¯¼å‘ï¼‰ |
| **æŒ‡ä»¤æ•°é‡** | è¶Šæ¥è¶Šå¤š<br/>ï¼ˆå†å²åŒ…è¢±ï¼‰ | é€‚ä¸­<br/>ï¼ˆå¤šç‰ˆæœ¬ï¼‰ | æœ€å°å¿…è¦<br/>ï¼ˆæ¨¡å—åŒ–ï¼‰ |
| **æˆæƒæ¨¡å¼** | ä¸“åˆ©ä¿æŠ¤<br/>ï¼ˆå„æ–­ï¼‰ | æˆæƒè´¹<br/>ï¼ˆå•†ä¸šï¼‰ | å¼€æºå…è´¹<br/>ï¼ˆå…±äº«ï¼‰ |
| **åˆ›æ–°é€Ÿåº¦** | æ…¢<br/>ï¼ˆå§”å‘˜ä¼šï¼‰ | ä¸­<br/>ï¼ˆå…¬å¸ï¼‰ | å¿«<br/>ï¼ˆç¤¾åŒºï¼‰ |

---

## ğŸ¦€ Rustï¼šç³»ç»Ÿç¼–ç¨‹çš„æ–°èŒƒå¼

### ä¸ºä»€ä¹ˆä¸ç”¨ C/C++ï¼Ÿ

#### ä¼ ç»Ÿç³»ç»Ÿè¯­è¨€çš„é—®é¢˜

**C è¯­è¨€çš„é™·é˜±**ï¼š

```c
// ç¤ºä¾‹ 1ï¼šå†…å­˜æ³„æ¼
char* get_data() {
    char* buffer = malloc(1024);
    strcpy(buffer, "Hello");
    return buffer;  // âŒ è°æ¥ freeï¼Ÿ
}

void process() {
    char* data = get_data();
    printf("%s\n", data);
    // âŒ å¿˜è®° free(data) â†’ å†…å­˜æ³„æ¼ï¼
}


// ç¤ºä¾‹ 2ï¼šUse-After-Free
char* global_ptr;

void setup() {
    char* temp = malloc(100);
    global_ptr = temp;
    free(temp);  // âŒ é‡Šæ”¾äº†å†…å­˜
}

void use_it() {
    strcpy(global_ptr, "Data");  // ğŸ’¥ è®¿é—®å·²é‡Šæ”¾çš„å†…å­˜ï¼
}


// ç¤ºä¾‹ 3ï¼šç¼“å†²åŒºæº¢å‡º
void copy_string(char* dest, const char* src) {
    strcpy(dest, src);  // âŒ æ²¡æ£€æŸ¥é•¿åº¦ï¼
}

int main() {
    char buffer[10];
    copy_string(buffer, "This is a very long string");
    // ğŸ’¥ ç¼“å†²åŒºæº¢å‡ºï¼Œå¯èƒ½è¢«æ”»å‡»ï¼
}


// ç¤ºä¾‹ 4ï¼šç©ºæŒ‡é’ˆè§£å¼•ç”¨
struct Node {
    int value;
    struct Node* next;
};

int get_next_value(struct Node* node) {
    return node->next->value;  // âŒ next å¯èƒ½æ˜¯ NULLï¼
}
```

**C++ çš„å¤æ‚æ€§**ï¼š

```cpp
// ç¤ºä¾‹ 1ï¼šRAII æ³„æ¼ï¼ˆå¼‚å¸¸å®‰å…¨ï¼‰
void process_file(const char* filename) {
    FILE* f = fopen(filename, "r");
    // ... å¤æ‚é€»è¾‘ ...
    if (error_condition) {
        return;  // âŒ å¿˜è®° fclose(f)ï¼
    }
    fclose(f);
}


// ç¤ºä¾‹ 2ï¼šæ‚¬å‚å¼•ç”¨
std::string& get_name() {
    std::string temp = "Alice";
    return temp;  // âŒ è¿”å›å±€éƒ¨å˜é‡çš„å¼•ç”¨ï¼
}

void use_name() {
    std::string& name = get_name();
    std::cout << name;  // ğŸ’¥ æœªå®šä¹‰è¡Œä¸ºï¼
}


// ç¤ºä¾‹ 3ï¼šç§»åŠ¨è¯­ä¹‰æ··ä¹±
std::vector<int> vec = {1, 2, 3};
auto vec2 = std::move(vec);
vec.push_back(4);  // âš ï¸ vec å·²è¢«ç§»åŠ¨ï¼Œä½¿ç”¨å®ƒæ˜¯æœªå®šä¹‰è¡Œä¸ºï¼
```

**ç»Ÿè®¡æ•°æ®**ï¼ˆæ¥è‡ª Microsoft/Googleï¼‰ï¼š
- ğŸ› **70%** çš„ä¸¥é‡å®‰å…¨æ¼æ´æºäºå†…å­˜å®‰å…¨é—®é¢˜
- ğŸ’¥ **50%** çš„ C/C++ é¡¹ç›®ä»£ç ç”¨äºæ‰‹åŠ¨å†…å­˜ç®¡ç†
- ğŸ”¥ **90%** çš„ Chrome å´©æºƒä¸å†…å­˜æœ‰å…³

---

### Rust çš„ä¸‰å¤§æ”¯æŸ±

#### æ”¯æŸ± 1ï¼šæ‰€æœ‰æƒç³»ç»Ÿï¼ˆOwnershipï¼‰

**æ ¸å¿ƒè§„åˆ™**ï¼š
1. æ¯ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…ï¼ˆownerï¼‰
2. ä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…
3. å½“æ‰€æœ‰è€…è¶…å‡ºä½œç”¨åŸŸï¼Œå€¼è¢«ä¸¢å¼ƒ

**ä»£ç ç¤ºä¾‹**ï¼š

```rust
// ç¤ºä¾‹ 1ï¼šæ‰€æœ‰æƒè½¬ç§»
fn main() {
    let s1 = String::from("hello");
    let s2 = s1;  // s1 çš„æ‰€æœ‰æƒè½¬ç§»ç»™ s2

    // println!("{}", s1);  // âŒ ç¼–è¯‘é”™è¯¯ï¼s1 å·²å¤±æ•ˆ
    println!("{}", s2);     // âœ… OK
}


// ç¤ºä¾‹ 2ï¼šå€Ÿç”¨ï¼ˆBorrowingï¼‰
fn calculate_length(s: &String) -> usize {
    s.len()  // åªå€Ÿç”¨ï¼Œä¸å–å¾—æ‰€æœ‰æƒ
}

fn main() {
    let s = String::from("hello");
    let len = calculate_length(&s);  // å€Ÿç”¨ s
    println!("{} has length {}", s, len);  // âœ… s ä»å¯ç”¨
}


// ç¤ºä¾‹ 3ï¼šå¯å˜å€Ÿç”¨
fn append_world(s: &mut String) {
    s.push_str(", world");
}

fn main() {
    let mut s = String::from("hello");
    append_world(&mut s);
    println!("{}", s);  // "hello, world"
}


// ç¤ºä¾‹ 4ï¼šå€Ÿç”¨è§„åˆ™ï¼ˆç¼–è¯‘æœŸæ£€æŸ¥ï¼‰
fn main() {
    let mut s = String::from("hello");

    let r1 = &s;      // âœ… ä¸å¯å˜å€Ÿç”¨
    let r2 = &s;      // âœ… å¯ä»¥æœ‰å¤šä¸ªä¸å¯å˜å€Ÿç”¨
    // let r3 = &mut s;  // âŒ ç¼–è¯‘é”™è¯¯ï¼ä¸èƒ½åŒæ—¶æœ‰å¯å˜å’Œä¸å¯å˜å€Ÿç”¨

    println!("{} and {}", r1, r2);

    let r3 = &mut s;  // âœ… ç°åœ¨å¯ä»¥äº†ï¼ˆr1ã€r2 ä¸å†ä½¿ç”¨ï¼‰
    r3.push_str("!");
}
```

**æ‰€æœ‰æƒç³»ç»Ÿçš„å¯è§†åŒ–**ï¼š

```
æ‰€æœ‰æƒè½¬ç§»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   s1    â”‚ owns String("hello")
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ move
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   s2    â”‚ owns String("hello")
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
s1 ä¸å†æœ‰æ•ˆ âŒ


å€Ÿç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    s    â”‚ owns String("hello")
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ &s (å€Ÿç”¨)
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€> å‡½æ•°ä½¿ç”¨ &s
     â”‚           (åªè¯»è®¿é—®)
     â”‚ <â”€â”€â”€â”€â”€â”€â”€ å‡½æ•°è¿”å›
     â–¼
   s ä»æœ‰æ•ˆ âœ…
```

---

#### æ”¯æŸ± 2ï¼šé›¶æˆæœ¬æŠ½è±¡ï¼ˆZero-Cost Abstractionsï¼‰

**åŸåˆ™**ï¼š"ä½ ä¸ç”¨çš„ä¸ä»˜è´¹ï¼Œä½ ç”¨çš„å’Œæ‰‹å†™ä¸€æ ·å¿«"

**ç¤ºä¾‹ 1ï¼šæ³›å‹å‡½æ•°**

```rust
// Rust æºç 
fn add<T: std::ops::Add<Output = T>>(a: T, b: T) -> T {
    a + b
}

fn main() {
    let result_i32 = add(10i32, 20i32);
    let result_f64 = add(1.5f64, 2.5f64);
}

// ç¼–è¯‘åç”Ÿæˆï¼ˆå•æ€åŒ–ï¼‰ï¼š
// fn add_i32(a: i32, b: i32) -> i32 { a + b }
// fn add_f64(a: f64, b: f64) -> f64 { a + b }

// æ±‡ç¼–è¾“å‡ºï¼ˆ-O2 ä¼˜åŒ–ï¼‰ï¼š
// add_i32:
//     add eax, esi    ; ç›´æ¥çš„åŠ æ³•ï¼Œæ— å¼€é”€ï¼
//     ret
```

**ç¤ºä¾‹ 2ï¼šè¿­ä»£å™¨**

```rust
// Rust æºç ï¼ˆé«˜çº§æŠ½è±¡ï¼‰
let sum: i32 = (1..=100)
    .filter(|x| x % 2 == 0)  // åªè¦å¶æ•°
    .map(|x| x * x)           // å¹³æ–¹
    .sum();                   // æ±‚å’Œ

// ç¼–è¯‘åç­‰ä»·äºï¼ˆæ‰‹å†™å¾ªç¯ï¼‰ï¼š
let mut sum = 0;
for x in 1..=100 {
    if x % 2 == 0 {
        sum += x * x;
    }
}

// æ±‡ç¼–è¾“å‡ºï¼šå®Œå…¨å†…è”ï¼Œæ— å‡½æ•°è°ƒç”¨å¼€é”€ï¼
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

```rust
use std::time::Instant;

fn hand_written_loop(data: &[i32]) -> i32 {
    let mut sum = 0;
    for &x in data {
        if x % 2 == 0 {
            sum += x * x;
        }
    }
    sum
}

fn iterator_version(data: &[i32]) -> i32 {
    data.iter()
        .filter(|&&x| x % 2 == 0)
        .map(|&x| x * x)
        .sum()
}

fn main() {
    let data: Vec<i32> = (1..=1000000).collect();

    let start = Instant::now();
    let sum1 = hand_written_loop(&data);
    let time1 = start.elapsed();

    let start = Instant::now();
    let sum2 = iterator_version(&data);
    let time2 = start.elapsed();

    println!("Hand-written: {:?}", time1);  // ~2.5ms
    println!("Iterator:     {:?}", time2);  // ~2.5ms (ç›¸åŒï¼)
    assert_eq!(sum1, sum2);
}
```

**ç»“æœ**ï¼šé›¶æˆæœ¬æŠ½è±¡æ˜¯çœŸçš„ï¼æ€§èƒ½å®Œå…¨ä¸€æ ·ã€‚

---

#### æ”¯æŸ± 3ï¼šç±»å‹ç³»ç»Ÿï¼ˆType Systemï¼‰

**Option ç±»å‹ï¼ˆæ¶ˆç­ç©ºæŒ‡é’ˆï¼‰**ï¼š

```rust
// Rust æ²¡æœ‰ nullï¼Œç”¨ Option è¡¨ç¤ºå¯èƒ½ä¸å­˜åœ¨çš„å€¼
enum Option<T> {
    Some(T),  // æœ‰å€¼
    None,     // æ— å€¼
}

// ç¤ºä¾‹ï¼šå®‰å…¨çš„é™¤æ³•
fn safe_divide(a: i32, b: i32) -> Option<i32> {
    if b == 0 {
        None  // é™¤æ•°ä¸ºé›¶ï¼Œè¿”å› None
    } else {
        Some(a / b)  // æ­£å¸¸æƒ…å†µï¼Œè¿”å›ç»“æœ
    }
}

fn main() {
    match safe_divide(10, 2) {
        Some(result) => println!("Result: {}", result),
        None => println!("Cannot divide by zero"),
    }

    // æˆ–è€…ç”¨ if let
    if let Some(result) = safe_divide(10, 0) {
        println!("Result: {}", result);
    } else {
        println!("Error!");  // è¿™é‡Œæ‰§è¡Œ
    }
}

// å¯¹æ¯” C è¯­è¨€ï¼ˆå®¹æ˜“å‡ºé”™ï¼‰ï¼š
// int divide(int a, int b) {
//     return a / b;  // âŒ b=0 æ—¶æœªå®šä¹‰è¡Œä¸ºï¼
// }
```

**Result ç±»å‹ï¼ˆé”™è¯¯å¤„ç†ï¼‰**ï¼š

```rust
use std::fs::File;
use std::io::Read;

// Result<T, E>ï¼šæ“ä½œå¯èƒ½æˆåŠŸï¼ˆOk(T)ï¼‰æˆ–å¤±è´¥ï¼ˆErr(E)ï¼‰
fn read_file(path: &str) -> Result<String, std::io::Error> {
    let mut file = File::open(path)?;  // ? ä¼ æ’­é”™è¯¯
    let mut contents = String::new();
    file.read_to_string(&mut contents)?;
    Ok(contents)
}

fn main() {
    match read_file("config.txt") {
        Ok(contents) => println!("File: {}", contents),
        Err(e) => eprintln!("Error: {}", e),
    }
}

// å¯¹æ¯” C è¯­è¨€ï¼ˆå®¹æ˜“å¿½ç•¥é”™è¯¯ï¼‰ï¼š
// FILE* f = fopen("config.txt", "r");
// if (f == NULL) {  // âš ï¸ å®¹æ˜“å¿˜è®°æ£€æŸ¥ï¼
//     // é”™è¯¯å¤„ç†
// }
// // ... ä½¿ç”¨ f ...
// fclose(f);
```

---

### CKB-VM ä¸­çš„ Rust å®è·µ

#### ç¤ºä¾‹ 1ï¼šæ³›å‹æ”¯æŒ 32 ä½å’Œ 64 ä½

```rust
// src/machine/mod.rs

// Register traitï¼šç»Ÿä¸€çš„å¯„å­˜å™¨æ¥å£
pub trait Register: Clone + PartialEq + ... {
    const BITS: u8;  // 32 æˆ– 64

    fn from_u64(x: u64) -> Self;
    fn to_u64(&self) -> u64;
    fn overflowing_add(&self, rhs: &Self) -> Self;
    // ... æ›´å¤šæ“ä½œ
}

// ä¸º u32 å®ç° Register
impl Register for u32 {
    const BITS: u8 = 32;

    fn from_u64(x: u64) -> Self {
        x as u32
    }

    fn to_u64(&self) -> u64 {
        *self as u64
    }

    fn overflowing_add(&self, rhs: &Self) -> Self {
        self.wrapping_add(*rhs)
    }
}

// ä¸º u64 å®ç° Register
impl Register for u64 {
    const BITS: u8 = 64;

    fn from_u64(x: u64) -> Self {
        x
    }

    fn to_u64(&self) -> u64 {
        *self
    }

    fn overflowing_add(&self, rhs: &Self) -> Self {
        self.wrapping_add(*rhs)
    }
}

// è™šæ‹Ÿæœºæ ¸å¿ƒï¼ˆæ³›å‹ï¼‰
pub struct DefaultCoreMachine<R: Register, M: Memory<REG = R>> {
    registers: [R; 32],
    pc: R,
    memory: M,
    // ...
}

// åŒä¸€å¥—ä»£ç ï¼Œæ”¯æŒä¸¤ç§æ¨¡å¼ï¼
type Machine32 = DefaultCoreMachine<u32, SparseMemory<u32>>;
type Machine64 = DefaultCoreMachine<u64, SparseMemory<u64>>;
```

**ç¼–è¯‘å™¨çš„é­”æ³•**ï¼š

```rust
// æºç ä¸­åªå†™ä¸€æ¬¡
impl<R: Register> DefaultCoreMachine<R, ...> {
    fn add(&mut self, rd: usize, rs1: usize, rs2: usize) {
        let result = self.registers[rs1]
            .overflowing_add(&self.registers[rs2]);
        self.registers[rd] = result;
    }
}

// ç¼–è¯‘åç”Ÿæˆä¸¤ä¸ªç‰ˆæœ¬ï¼ˆå•æ€åŒ–ï¼‰ï¼š

// ç‰ˆæœ¬ 1ï¼šu32
impl DefaultCoreMachine<u32, ...> {
    fn add(&mut self, rd: usize, rs1: usize, rs2: usize) {
        let result = self.registers[rs1].wrapping_add(self.registers[rs2]);
        self.registers[rd] = result;
    }
}

// ç‰ˆæœ¬ 2ï¼šu64
impl DefaultCoreMachine<u64, ...> {
    fn add(&mut self, rd: usize, rs1: usize, rs2: usize) {
        let result = self.registers[rs1].wrapping_add(self.registers[rs2]);
        self.registers[rd] = result;
    }
}

// æ±‡ç¼–è¾“å‡ºï¼ˆx86-64ï¼‰ï¼š

// u32 ç‰ˆæœ¬ï¼š
// mov eax, [registers + rs1*4]
// add eax, [registers + rs2*4]
// mov [registers + rd*4], eax

// u64 ç‰ˆæœ¬ï¼š
// mov rax, [registers + rs1*8]
// add rax, [registers + rs2*8]
// mov [registers + rd*8], rax

// å®Œå…¨å†…è”ï¼Œé›¶å¼€é”€ï¼
```

---

#### ç¤ºä¾‹ 2ï¼šå†…å­˜å®‰å…¨ï¼ˆæ—  unsafe å—ï¼‰

```rust
// src/memory/sparse.rs

pub struct SparseMemory<R: Register> {
    pages: HashMap<u64, Vec<u8>>,  // é¡µè¡¨
    flags: HashMap<u64, u8>,        // æƒé™æ ‡å¿—
    _phantom: PhantomData<R>,
}

impl<R: Register> Memory for SparseMemory<R> {
    type REG = R;

    fn load8(&mut self, addr: &R) -> Result<R, Error> {
        let addr_u64 = addr.to_u64();
        let page_num = addr_u64 / RISCV_PAGESIZE;
        let offset = (addr_u64 % RISCV_PAGESIZE) as usize;

        // è·å–é¡µï¼ˆè‡ªåŠ¨æ£€æŸ¥è¾¹ç•Œï¼‰
        let page = self.pages.get(&page_num)
            .ok_or(Error::OutOfBound)?;

        // è¯»å–å­—èŠ‚ï¼ˆè‡ªåŠ¨æ£€æŸ¥è¾¹ç•Œï¼‰
        let byte = page.get(offset)
            .ok_or(Error::OutOfBound)?;

        Ok(R::from_u64(*byte as u64))
    }

    fn store8(&mut self, addr: &R, value: &R) -> Result<(), Error> {
        let addr_u64 = addr.to_u64();
        let page_num = addr_u64 / RISCV_PAGESIZE;
        let offset = (addr_u64 % RISCV_PAGESIZE) as usize;

        // æ£€æŸ¥æƒé™
        let flag = self.flags.get(&page_num)
            .ok_or(Error::OutOfBound)?;
        if (*flag & FLAG_WRITABLE) == 0 {
            return Err(Error::InvalidPermission);
        }

        // è·å–å¯å˜é¡µ
        let page = self.pages.get_mut(&page_num)
            .ok_or(Error::OutOfBound)?;

        // å†™å…¥å­—èŠ‚ï¼ˆè‡ªåŠ¨æ£€æŸ¥è¾¹ç•Œï¼‰
        let byte = page.get_mut(offset)
            .ok_or(Error::OutOfBound)?;
        *byte = (value.to_u64() & 0xFF) as u8;

        Ok(())
    }
}

// âœ… ç¼–è¯‘å™¨ä¿è¯ï¼š
// 1. æ— æ•°ç»„è¶Šç•Œ
// 2. æ— ç©ºæŒ‡é’ˆè§£å¼•ç”¨
// 3. æ— æ•°æ®ç«äº‰
// 4. æ— å†…å­˜æ³„æ¼
```

---

### çœŸå®æ”¶ç›Šï¼šBug ç»Ÿè®¡

**CKB-VM å¼€å‘å†å²åˆ†æ**ï¼ˆGitHub æ•°æ®ï¼‰ï¼š

```
æ€»æäº¤æ•°ï¼š   2,500+
ç¼–è¯‘é”™è¯¯ï¼š   ~1,200  (è¢«ç¼–è¯‘å™¨æ•è·)
è¿è¡Œæ—¶é”™è¯¯ï¼š ~30     (é€»è¾‘é”™è¯¯ï¼Œéœ€æµ‹è¯•å‘ç°)
å†…å­˜é”™è¯¯ï¼š   0       (Rust ä¿è¯)

å¯¹æ¯”é¢„ä¼°ï¼ˆå¦‚æœç”¨ C å®ç°ï¼‰ï¼š
ç¼–è¯‘é”™è¯¯ï¼š   ~500   (ç±»å‹æ£€æŸ¥è¾ƒå¼±)
è¿è¡Œæ—¶é”™è¯¯ï¼š ~200   (å†…å­˜é”™è¯¯å¤š)
å†…å­˜é”™è¯¯ï¼š   ~150   (70% éƒ½æ˜¯å†…å­˜é—®é¢˜)
```

**é”™è¯¯ç±»å‹åˆ†å¸ƒ**ï¼š

```mermaid
pie title CKB-VM Bug åˆ†å¸ƒï¼ˆå®é™…ï¼‰
    "ç¼–è¯‘æœŸæ•è·" : 97
    "é€»è¾‘é”™è¯¯" : 3
    "å†…å­˜å®‰å…¨é—®é¢˜" : 0
```

```mermaid
pie title é¢„ä¼° C é¡¹ç›® Bug åˆ†å¸ƒ
    "ç¼–è¯‘æœŸæ•è·" : 30
    "é€»è¾‘é”™è¯¯" : 20
    "å†…å­˜å®‰å…¨é—®é¢˜" : 50
```

---

## ğŸ¯ æŠ€æœ¯é€‰å‹æ€»ç»“ï¼šé»„é‡‘ç»„åˆçš„è¯ç”Ÿ

### RISC-V + Rust = å®Œç¾åŒ¹é…

#### å¯¹åº”å…³ç³»è¡¨

| éœ€æ±‚ | RISC-V çš„è´¡çŒ® | Rust çš„è´¡çŒ® | ç»“æœ |
|------|--------------|-------------|------|
| **å®‰å…¨æ€§** | ç®€å•æŒ‡ä»¤é›†<br/>æ˜“å®¡è®¡ | å†…å­˜å®‰å…¨<br/>ç±»å‹å®‰å…¨ | âœ… åŒé‡ä¿éšœ |
| **ç¡®å®šæ€§** | è§„èŒƒä¸¥æ ¼<br/>æ— æ­§ä¹‰ | æ— æœªå®šä¹‰è¡Œä¸º<br/>å¯é¢„æµ‹ | âœ… ç»å¯¹ç¡®å®š |
| **æ€§èƒ½** | ç²¾ç®€é«˜æ•ˆ<br/>æ˜“ä¼˜åŒ– | é›¶æˆæœ¬æŠ½è±¡<br/>æ‰‹å†™çº§æ€§èƒ½ | âœ… æè‡´æ€§èƒ½ |
| **å¯ç»´æŠ¤æ€§** | æŒ‡ä»¤å°‘<br/>æ˜“ç†è§£ | å¼ºç±»å‹<br/>ç¼–è¯‘å™¨ååŠ© | âœ… æ˜“äºç»´æŠ¤ |
| **å¼€æ”¾æ€§** | å¼€æºå…è´¹<br/>æ— ä¸“åˆ© | å¼€æºç”Ÿæ€<br/>æ´»è·ƒç¤¾åŒº | âœ… å®Œå…¨å¼€æ”¾ |
| **å¯æ‰©å±•æ€§** | æ¨¡å—åŒ–<br/>è‡ªç”±ç»„åˆ | Trait ç³»ç»Ÿ<br/>æ³›å‹ç¼–ç¨‹ | âœ… é«˜åº¦çµæ´» |

---

### æ¶æ„å†³ç­–çš„å“²å­¦

#### è®¾è®¡åŸåˆ™

```mermaid
graph TD
    A[æŠ€æœ¯é€‰å‹åŸåˆ™] --> B[ç®€å•æ€§]
    A --> C[æ­£ç¡®æ€§]
    A --> D[æ€§èƒ½]
    A --> E[å¼€æ”¾æ€§]

    B --> B1[RISC-V: 47æ¡åŸºç¡€æŒ‡ä»¤]
    B --> B2[Rust: æ˜¾å¼ä¼˜äºéšå¼]

    C --> C1[RISC-V: è§„èŒƒä¸¥æ ¼å®šä¹‰]
    C --> C2[Rust: ç¼–è¯‘æœŸæ£€æŸ¥]

    D --> D1[RISC-V: ç²¾ç®€æŒ‡ä»¤]
    D --> D2[Rust: é›¶æˆæœ¬æŠ½è±¡]

    E --> E1[RISC-V: BSDå¼€æº]
    E --> E2[Rust: MIT/Apacheå¼€æº]

    style A fill:#f96,stroke:#333,stroke-width:3px
    style B1 fill:#9f6,stroke:#333
    style C2 fill:#6f9,stroke:#333
```

---

### ä¸å…¶ä»–æ–¹æ¡ˆçš„å¯¹æ¯”

#### æ–¹æ¡ˆå¯¹æ¯”è¡¨

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | CKB-VMçš„é€‰æ‹© |
|------|------|------|-------------|
| **x86 + C** | æˆç†Ÿç¨³å®š<br/>å·¥å…·å®Œå–„ | å¤æ‚<br/>ä¸å®‰å…¨<br/>ä¸“åˆ©å°é—­ | âŒ ä¸é€‰ |
| **ARM + C++** | æ€§èƒ½å¥½<br/>ç§»åŠ¨ä¼˜å…ˆ | æˆæƒè´¹<br/>å†…å­˜ä¸å®‰å…¨ | âŒ ä¸é€‰ |
| **Wasm + Rust** | ç°ä»£<br/>å¤šè¯­è¨€ | ä¸å¤Ÿç¡®å®š<br/>æŒ‡ä»¤é›†å¤æ‚ | âš ï¸ å¯è€ƒè™‘ä½†ä¸å¦‚ RISC-V |
| **RISC-V + C** | å¼€æº<br/>ç®€å• | å†…å­˜ä¸å®‰å…¨ | âš ï¸ æ¥è¿‘ä½†ä¸å¤Ÿå®‰å…¨ |
| **RISC-V + Rust** | å¼€æº<br/>ç®€å•<br/>å®‰å…¨<br/>é«˜æ€§èƒ½ | å­¦ä¹ æ›²çº¿ | âœ… **æœ€ä½³é€‰æ‹©** |

---

### ä¸“å®¶è§†è§’ï¼šæ¶æ„æƒè¡¡åˆ†æ

#### Trade-off 1ï¼šç®€å•æ€§ vs åŠŸèƒ½æ€§

**é—®é¢˜**ï¼šRISC-V å¤ªç®€å•ï¼Œæ˜¯å¦åŠŸèƒ½ä¸è¶³ï¼Ÿ

**åˆ†æ**ï¼š
```
åŠŸèƒ½è¦†ç›–ç‡åˆ†æï¼ˆåŒºå—é“¾åœºæ™¯ï¼‰ï¼š

éœ€è¦çš„åŠŸèƒ½ï¼š
âœ… æ•´æ•°è¿ç®—        â†’ RV64I æä¾›
âœ… ä¹˜æ³•é™¤æ³•        â†’ RV64M æä¾›
âœ… åŸå­æ“ä½œ        â†’ RV64A æä¾›
âœ… ä½æ“ä½œ          â†’ RV64B æä¾›
âŒ æµ®ç‚¹è¿ç®—        â†’ ä¸éœ€è¦ï¼ˆç¡®å®šæ€§ï¼‰
âŒ å‘é‡è¿ç®—        â†’ ä¸éœ€è¦ï¼ˆæš‚æ—¶ï¼‰
âŒ ç‰¹æƒæŒ‡ä»¤        â†’ ä¸éœ€è¦ï¼ˆç”¨æˆ·æ€ï¼‰

ç»“è®ºï¼šRV64IMACB å®Œå…¨æ»¡è¶³éœ€æ±‚ï¼Œ
     ç®€å•æ€§å¸¦æ¥çš„æ˜¯ æ˜“å®ç°ã€æ˜“å®¡è®¡ã€é«˜æ€§èƒ½ã€‚
```

---

#### Trade-off 2ï¼šRust å­¦ä¹ æ›²çº¿ vs é•¿æœŸæ”¶ç›Š

**é—®é¢˜**ï¼šRust å­¦ä¹ éš¾åº¦é«˜ï¼Œå€¼å¾—å—ï¼Ÿ

**æˆæœ¬æ”¶ç›Šåˆ†æ**ï¼š

```
æˆæœ¬ï¼š
- å­¦ä¹ æ›²çº¿ï¼š~3-6 ä¸ªæœˆè¾¾åˆ°ç”Ÿäº§åŠ›
- ç¼–è¯‘æ—¶é—´ï¼šæ¯” C/C++ æ…¢ 2-3 å€
- ç¼–è¯‘é”™è¯¯ï¼šåˆæœŸè¾ƒå¤šï¼ˆå®é™…æ˜¯å¥½äº‹ï¼‰

æ”¶ç›Šï¼š
- Bug å‡å°‘ï¼š~70%ï¼ˆMicrosoft æ•°æ®ï¼‰
- å†…å­˜æ¼æ´ï¼šæ¥è¿‘ 0
- é‡æ„å®‰å…¨ï¼šç¼–è¯‘å™¨ä¿è¯æ­£ç¡®æ€§
- é•¿æœŸç»´æŠ¤ï¼šä»£ç è´¨é‡ç¨³å®š

æŠ•èµ„å›æŠ¥ç‡ï¼ˆROIï¼‰ï¼š
ç¬¬ 1 å¹´ï¼šæˆæœ¬ > æ”¶ç›Šï¼ˆå­¦ä¹ æœŸï¼‰
ç¬¬ 2 å¹´ï¼šæˆæœ¬ = æ”¶ç›Šï¼ˆå¹³è¡¡æœŸï¼‰
ç¬¬ 3+ å¹´ï¼šæ”¶ç›Š >> æˆæœ¬ï¼ˆå›æŠ¥æœŸï¼‰

åŒºå—é“¾é¡¹ç›®ç‰¹ç‚¹ï¼š
- éœ€è¦é•¿æœŸç»´æŠ¤ï¼ˆ>5 å¹´ï¼‰
- å®‰å…¨æ€§è¦æ±‚æé«˜
- ä»£ç éœ€å®¡è®¡

ç»“è®ºï¼šRust çš„å­¦ä¹ æˆæœ¬åœ¨é•¿æœŸçœ‹æ˜¯å€¼å¾—çš„ã€‚
```

---

## ğŸ¬ ç« èŠ‚æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **RISC-V çš„ä¼˜åŠ¿**ï¼š
   - ğŸ—ï¸ ç®€æ´ä¼˜é›…ï¼ˆ47 æ¡åŸºç¡€æŒ‡ä»¤ï¼‰
   - ğŸ”“ å¼€æºå…è´¹ï¼ˆBSD è®¸å¯ï¼‰
   - ğŸ“ æ¨¡å—åŒ–è®¾è®¡ï¼ˆè‡ªç”±ç»„åˆï¼‰
   - âœ… è™šæ‹ŸåŒ–å‹å¥½ï¼ˆæ˜“å®ç°ï¼‰

2. **Rust çš„ä¼˜åŠ¿**ï¼š
   - ğŸ›¡ï¸ å†…å­˜å®‰å…¨ï¼ˆæ‰€æœ‰æƒç³»ç»Ÿï¼‰
   - âš¡ é›¶æˆæœ¬æŠ½è±¡ï¼ˆé«˜æ€§èƒ½ï¼‰
   - ğŸ¯ å¼ºç±»å‹ç³»ç»Ÿï¼ˆç¼–è¯‘æœŸæ£€æŸ¥ï¼‰
   - ğŸ¦€ ç°ä»£è¯­è¨€ç‰¹æ€§ï¼ˆæ¨¡å¼åŒ¹é…ã€traitï¼‰

3. **é»„é‡‘ç»„åˆ**ï¼š
   - RISC-V æä¾›ç®€å•ã€ç¡®å®šã€å¼€æ”¾çš„ç¡¬ä»¶æŠ½è±¡
   - Rust æä¾›å®‰å…¨ã€é«˜æ•ˆã€ä¼˜é›…çš„è½¯ä»¶å®ç°
   - ä¸¤è€…ç»“åˆ = åŒºå—é“¾è™šæ‹Ÿæœºçš„æœ€ä½³é€‰æ‹©

---

## ğŸ”œ ä¸‹ä¸€ç« é¢„å‘Š

åœ¨[ç¬¬ä¸‰ç« ã€Šé¡¹ç›®æ¦‚è§ˆï¼šCKB-VM æ˜¯ä»€ä¹ˆï¼Ÿã€‹](03_overview.md)ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨ï¼š

- ğŸŒŸ CKB-VM åœ¨ Nervos CKB åŒºå—é“¾ä¸­çš„å®šä½
- ğŸ¯ å››å¤§æ ¸å¿ƒåŠŸèƒ½è¯¦è§£ï¼ˆç¨‹åºæ‰§è¡Œã€èµ„æºè®¡é‡ã€ç³»ç»Ÿè°ƒç”¨ã€å†…å­˜ä¿æŠ¤ï¼‰
- ğŸ—ï¸ åº”ç”¨åœºæ™¯å’Œå®é™…æ¡ˆä¾‹
- ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•æ•°æ®

---

## ğŸ“š æ‰©å±•é˜…è¯»

### RISC-V èµ„æº
- [RISC-V å®˜æ–¹è§„èŒƒ](https://riscv.org/technical/specifications/)
- [RISC-V æŒ‡ä»¤é›†å¡ç‰‡](https://www.cl.cam.ac.uk/teaching/1617/ECAD+Arch/files/docs/RISCVGreenCardv8-20151013.pdf)
- [ã€ŠComputer Organization and Design RISC-V Editionã€‹](https://www.amazon.com/Computer-Organization-Design-RISC-V-Architecture/dp/0128122757)

### Rust èµ„æº
- [Rust å®˜æ–¹æ•™ç¨‹](https://doc.rust-lang.org/book/)
- [Rust by Example](https://doc.rust-lang.org/rust-by-example/)
- [ã€ŠProgramming Rustã€‹](https://www.oreilly.com/library/view/programming-rust-2nd/9781492052586/)

### è®ºæ–‡
- "The RISC-V Instruction Set Manual"
- "Rust: A Language for Systems Programming"

---

**ç»§ç»­ä¸‹ä¸€ç« ** â†’ [ç¬¬ä¸‰ç« ï¼šé¡¹ç›®æ¦‚è§ˆ](03_overview.md)
