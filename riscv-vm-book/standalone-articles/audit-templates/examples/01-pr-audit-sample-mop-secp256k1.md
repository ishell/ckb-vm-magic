# 审计样例 01：MOP 融合优化 secp256k1 路径（有条件通过）

> 类型：性能优化 + 指令映射调整  
> 审计结论：`条件通过`  
> 目的：展示“性能收益存在，但治理门禁尚未补齐”时如何写结论。

## 1. PR 基本信息（示例）

- PR 标题：`optimize secp256k1 scalar mul by mop fusion`
- PR 链接：`(示例) https://example.local/pr/427`
- 负责人：`vm-crypto-owner`
- 审计人：`security-reviewer-A`
- 目标模块：`src/instructions/`、`src/machine/`、`tests/test_mop.rs`
- 关联 issue/RFC：`RFC-crypto-mop-fusion-v2`
- 影响范围：VM 执行层 + 计费模型

## 2. 变更分类

- [ ] 新增算法实现
- [ ] 现有算法重构
- [x] 性能优化（无语义变更）
- [x] 指令映射调整（MOP 路径）
- [x] 计费模型调整（cycles）
- [ ] 汇编快路径变更

## 3. 一针见血风险

该改动把热点路径融合为更少步数，平均 cycles 降低明显；但如果长尾输入下 cycles 下降幅度与平均值差异过大，可能造成计费公平性偏移，形成“非典型输入套利窗口”。

## 4. 证据摘要

### 4.1 语义一致性

- 证据命令：

```bash
cargo test --test test_mop -- --nocapture
cargo test --test test_versions -- --nocapture
bash docs/riscv-vm-book/tools/run_labs.sh --batch 3 --mode smoke --skip-asm
```

- 结果摘要：
  - 功能断言全部通过；
  - 错误码行为未变化；
  - 版本回放测试未出现分歧。

结论：语义层`通过`。

### 4.2 计费变化

- 基线 workload（示例，10k 样本）：
  - 中位数 cycles：`-14.8%`
  - p95 cycles：`-6.1%`
  - p99 cycles：`-1.4%`
- 观察：长尾收益显著低于中位收益，且 p99 波动扩大。

结论：计费层`有条件通过`，需补长尾样本校准。

### 4.3 边界与安全

- 未新增 syscall；
- 未触及 W^X 权限切换路径；
- 未引入新的 unsafe 块。

结论：边界层`通过`。

### 4.4 治理与发布

当前 PR 缺失两项发布门禁：

1. 未定义“长尾波动阈值”超限后的回滚触发条件；
2. 未给出灰度窗口内的观测指标 owner。

结论：治理层`未通过`。

## 5. 审计检查表（已填写）

### A. 协议语义

- [x] 同输入同初始状态下结果可重放
- [x] 错误码与退出语义保持兼容
- [x] 边界输入无未定义行为

### B. 计费与性能

- [x] cycles 变化具备解释与样本支持
- [ ] 长尾输入行为已观测并完成阈值化
- [x] smoke 与 full 结论边界明确

### C. 边界与安全

- [x] 宿主接口与内存权限边界未扩张
- [x] 新增路径具备失败可观测性（日志/错误码）
- [x] 回滚路径可执行且有演练记录

### D. 治理与发布

- [x] 版本兼容结论与证据一致
- [ ] 发布门禁、灰度策略、冻结条件已完整定义
- [ ] 责任人、观察窗口、复盘机制已完整指定

## 6. 审计结论（签署区）

- 结论：`[ ] 通过  [x] 条件通过  [ ] 拒绝`
- 风险等级：`[ ] 低  [x] 中  [ ] 高`
- 发布建议：
  - 允许进入灰度；
  - 不允许直接全量；
  - 必须补齐长尾阈值与回滚触发策略。
- 回滚触发条件（建议）：
  1. p99 cycles 波动超过基线 `+5%` 连续 3 个观测窗口；
  2. 任一后端出现错误码不一致；
  3. 同输入出现不可解释状态分叉。
- 审计人：`security-reviewer-A`
- 日期：`2026-02-08`

## 7. 必须补齐项（上线前）

1. 在文档中明确 p95/p99 阈值与触发动作。
2. 在 PR 描述中挂载完整 `lab-run-report.md` 与原始日志路径。
3. 在发布计划中指定灰度 owner 与 7 天观测复盘时间点。

## 8. 一针见血结论

这个 PR 不是“不能上”，而是“不能裸上”。性能收益成立，但治理约束未闭环；先补门禁，再谈全量。
