# 审计样例 02：新增 host time syscall（拒绝通过）

> 类型：syscall 边界扩张  
> 审计结论：`拒绝`  
> 目的：展示“看似方便的功能增强”如何直接破坏共识约束。

## 1. PR 基本信息（示例）

- PR 标题：`add ecall 200 for host unix timestamp`
- PR 链接：`(示例) https://example.local/pr/433`
- 负责人：`vm-runtime-owner`
- 审计人：`security-reviewer-B`
- 目标模块：`src/machine/mod.rs`、`src/syscalls/`、`tests/test_simple.rs`
- 关联 issue/RFC：`feature-request-host-time`
- 影响范围：syscall 边界 + 共识确定性

## 2. 变更分类

- [ ] 新增算法实现
- [ ] 现有算法重构
- [ ] 性能优化（无语义变更）
- [ ] 指令映射调整
- [ ] 计费模型调整
- [x] 宿主接口扩展（新增 syscall）

## 3. 一针见血风险

该 PR 允许 VM 程序读取宿主当前时间。时间是节点本地非共识状态，不同节点会返回不同值，直接破坏“同输入同状态同输出”的共识前提。

## 4. 证据摘要

### 4.1 复现实验

```bash
cargo test --test test_simple -- --nocapture
cargo run --example ckb_vm_runner -- --mode interpreter64 tests/programs/simple64
```

实验记录（示例）：

- 同一程序、同一输入，间隔 2 秒运行两次，返回值不同；
- 在两台节点机器上运行，返回值也不同；
- 交易执行结果依赖本地时间，无法重放一致。

结论：语义层`失败`。

### 4.2 计费与经济层

- cycles 本身可稳定计量；
- 但输出结果不确定导致交易可验证性断裂，计费正确已失去意义。

结论：计费层`不成立`（前提被破坏）。

### 4.3 边界与安全层

- 新增 syscall 扩张了宿主能力面；
- 返回值来自外部时钟，属于未受共识约束的环境依赖；
- 未提供 deterministic 替代方案。

结论：边界层`失败`。

### 4.4 治理层

- PR 中无回滚机制；
- 无跨版本兼容策略；
- 无发布后观测与补救流程。

结论：治理层`失败`。

## 5. 审计检查表（已填写）

### A. 协议语义

- [ ] 同输入同初始状态下结果可重放
- [ ] 错误码与退出语义保持兼容
- [ ] 边界输入无未定义行为

### B. 计费与性能

- [ ] cycles 变化具备解释与样本支持
- [ ] 长尾输入行为已观测，不只看平均值
- [x] smoke 与 full 结论边界明确

### C. 边界与安全

- [ ] 宿主接口与内存权限边界未扩张
- [ ] 新增路径具备失败可观测性（日志/错误码）
- [ ] 回滚路径可执行且有演练记录

### D. 治理与发布

- [ ] 版本兼容结论与证据一致
- [ ] 发布门禁、灰度策略、冻结条件已定义
- [ ] 责任人、观察窗口、复盘机制已指定

## 6. 审计结论（签署区）

- 结论：`[ ] 通过  [ ] 条件通过  [x] 拒绝`
- 风险等级：`[ ] 低  [ ] 中  [x] 高`
- 发布建议：拒绝合并到共识路径。
- 回滚触发条件：不适用（建议直接关闭 PR）。
- 审计人：`security-reviewer-B`
- 日期：`2026-02-08`

## 7. 替代方案建议

可接受的替代方向：

1. 不提供“宿主当前时间”能力；
2. 如业务确需时间语义，应由交易输入显式携带并在共识规则中验证；
3. 由协议层定义可验证时间窗口，而非由 VM 读取宿主状态。

## 8. 一针见血结论

这个 PR 的问题不是实现细节，而是方向错误：它把非共识状态引入共识执行。该类改动应在设计阶段就被否决。
