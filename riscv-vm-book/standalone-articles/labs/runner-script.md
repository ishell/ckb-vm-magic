# 实验脚本化执行手册（`run_labs.sh`）

## 一针见血结论

把实验命令手动拷贝到终端并不能形成工程证据链；`run_labs.sh` 的核心价值不是“省几次敲键盘”，而是把 **批次目标、命令集合、执行日志、结果汇总** 固化为统一格式，使实验结果能够进入评审、复核与回归流程。

## 1. 为什么要脚本化

在区块链 VM 场景里，实验记录不是“个人笔记”，而是架构决策依据。脚本化解决的是四个高频失真点：

1. 命令漂移：同一实验在不同人机器上参数不一致。
2. 证据缺口：只记录“通过/失败”，没有完整输出日志。
3. 报告异构：每人自己写报告，无法批量对比。
4. 复现成本高：审稿人不知道从何开始复跑。

`run_labs.sh` 的设计目标就是消除这四个失真点。

## 2. 执行模型：批次 -> 用例 -> 证据

脚本内部把实验定义为五元组：

- `batch`：所属批次（1/2/3）。
- `case_id`：用例编号（如 `2.3`）。
- `title`：简短说明。
- `command`：可直接执行的命令。
- `expectation`：人工复核时应关注的结论。

这意味着脚本不仅“执行命令”，还把“我们为什么执行它”写进报告模板，降低后续审计时的解释成本。

## 3. 参数设计与使用策略

| 参数 | 作用 | 何时使用 |
|---|---|---|
| `--batch <1|2|3|all>` | 选择实验范围 | 日常只跑一个批次；发布前跑 `all` |
| `--mode <full|smoke>` | 选择命令强度 | 本地回归先 `smoke`，上线评审用 `full` |
| `--skip-asm` | 跳过依赖 `--features asm` 的命令 | 缺少 asm 构建条件或临时排障 |
| `--stop-on-fail` | 首个失败立即停止 | 快速定位首个断点 |
| `--output-dir <path>` | 自定义产物目录 | CI 场景写入固定归档目录 |

建议顺序：

1. `smoke` 验证环境可用；
2. 批次级 `full` 做专题评审；
3. `all + full` 做发布前总回归。

## 4. 报告产物结构（默认输出）

默认路径：`docs/riscv-vm-book/reports/labs/<timestamp>/`

- `lab-run-report.md`：适合评审阅读的汇总报告。
- `lab-run-report.csv`：适合表格工具与脚本二次分析。
- `logs/*.log`：每条命令对应独立原始日志。

这三层分别面向：

- 研发负责人（先看 Markdown 总览）；
- 数据/质量工程（读取 CSV 聚合）；
- 问题定位者（钻取单条日志）。

退出码语义：

- 全部用例 `passed` 或 `skipped` 时返回 `0`。
- 存在任意 `failed` 用例时返回 `1`（适合 CI 直接门禁）。

## 5. 标准执行剧本

### 5.1 首次接入（推荐）

```bash
bash docs/riscv-vm-book/tools/run_labs.sh --batch 1 --mode smoke --skip-asm
```

目标：验证脚本链路、报告产物与基础测试可用。

### 5.2 批次评审

```bash
bash docs/riscv-vm-book/tools/run_labs.sh --batch 2 --mode full --stop-on-fail
```

目标：在中断点处立即停机，减少无效等待。

### 5.3 发布前回归

```bash
bash docs/riscv-vm-book/tools/run_labs.sh --batch all --mode full
```

目标：形成可归档的全量证据包。

## 6. 失败排障路径（建议固定化）

当某个 `case_id` 失败时，按以下顺序处理：

1. 打开对应 `logs/<case>.log`，确认失败是编译、运行还是断言层。
2. 在报告中填写“Cross-backend differences observed”。
3. 判断是否属于环境因素（工具链、权限、平台差异）。
4. 仅在证据充分时才修改主文结论；否则先修复实现或测试。

这条路径的意义是：先保证证据完整，再讨论结论变更。

## 7. CI 接入建议

最小化接入示例：

```bash
bash docs/riscv-vm-book/tools/run_labs.sh \
  --batch all \
  --mode smoke \
  --skip-asm \
  --output-dir /tmp/ckb-vm-lab-report
```

CI 里建议把 `lab-run-report.md` 与 `lab-run-report.csv` 作为构建产物上传，并在 PR 描述中附报告路径。

## 8. 扩展脚本时的约束

新增实验用例时，建议遵守三条规则：

1. 用例命名必须反映“语义目标”而非“文件名”。
2. `expectation` 必须可被人工验证，避免空泛表述。
3. 同一批次应覆盖“语义正确性 + 边界行为 + 回归稳定性”三类命令。

## 9. 与主文/附录的对应关系

- 与主文关系：脚本把章节中的结论转成可执行证据。
- 与图示长文关系：每篇长文至少应能映射到一条实验命令。
- 与附录 F 关系：失败日志可直接进入 PR 审计模板。
- 与教学资料关系：90 分钟教学包的 live demo 可直接调用本脚本。

## 10. 常见误区

1. 把 `smoke` 结果当作发布结论。
2. 失败后只截图，不保留原始日志。
3. 跳过 asm 后仍声称完成“后端一致性”验证。
4. 只看通过率，不看长尾样本耗时与差异。

## 11. 快速复核清单

- [ ] 报告目录已生成（md/csv/log）
- [ ] 每个失败用例都有日志定位
- [ ] 关键结论已回填到实验记录
- [ ] 审计模板（附录 F）已引用对应 case id
- [ ] 需要教学演示的命令已做 smoke 预跑
