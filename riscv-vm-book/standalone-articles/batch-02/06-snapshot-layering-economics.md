# 图 6-1 长文：快照分层不是序列化技巧，而是执行经济学核心

## 摘要

图 6-1 展示的“dirty pages + pages_from_source”分层，不只是节省存储空间。它在区块链 VM 中的真正价值是：

- 让长任务可分段支付
- 让恢复语义可验证
- 让状态传输成本可预测

快照机制本质上是执行层的经济基础设施。

## 1. 原图重述：状态分层

图 6-1 的核心结构：

```text
VM state
 = registers + pc + cycles + max_cycles + lr
 + memory pages

snapshot v1: dirty pages
snapshot v2: dirty pages + pages_from_source
```

这里的关键不是“存什么”，而是“哪些数据可以引用，哪些必须复制”。

## 2. Snapshot v1 与 v2 的本质差异

### v1（脏页快照）

- 优点：实现简单，语义直观
- 缺点：对稳定数据重复存储，体积可能偏大

### v2（DataSource 分层）

- 优点：稳定来源页可引用，减少冗余
- 缺点：实现复杂，需要维护来源映射一致性

当程序页与只读数据占比较高时，v2 往往更有现实收益。

## 3. 恢复正确性的四条不变量

恢复后应满足：

1. `pc/registers/cycles/max_cycles` 一致
2. 页内容和页标志一致
3. `load reservation address` 一致
4. 恢复后继续执行结果与不中断执行一致

这四条可以视作“快照正确”的最小证明集合。

## 4. 为什么这是经济问题而不仅是工程问题

链上长任务若必须“一次性跑完”，会出现：

- 用户必须预付高预算
- 节点需要承受长时间占用
- 失败重试成本高

快照分段执行将其改写为：

- 按阶段支付
- 可恢复推进
- 可重放验证

这直接提升了执行层的经济可用性。

## 5. 常见失效场景

### 场景 A：恢复不校验版本

结果：新旧语义混跑，重放结果漂移。

### 场景 B：dirty/source 标记混乱

结果：恢复后页内容与标志不一致，错误具有延迟暴露特征。

### 场景 C：只比最终退出码，不比中间状态

结果：隐藏寄存器或内存偏差难以及时发现。

## 6. 指标化管理建议

长期记录：

- `dirty_pages / total_pages`
- `pages_from_source / total_pages`
- `snapshot_size_per_tx`
- `resume_success_rate`

如果这些指标不可见，快照优化就很容易沦为“感觉变快”。

## 7. 审计清单（可执行）

1. 是否强校验快照版本与机器版本一致？
2. 是否验证恢复后继续执行与一次性执行等价？
3. 是否有覆盖跨页、边界、空参数等极端用例？
4. 是否记录并监控快照体积和恢复成功率？

## 8. 与主文映射

- 对应章节：`第 6 章`
- 关键代码：`src/snapshot.rs`, `src/snapshot2.rs`
- 关联附录：`附录 G`（作者改稿清单）

## 9. 一针见血结论

快照分层的真正价值不是“省空间”，而是把链上长计算变成可支付、可恢复、可验证的连续过程。

