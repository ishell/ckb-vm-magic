# 图 10-1 长文：密码学扩展映射，B/M/A/MOP 的真实分工

## 摘要

图 10-1 把“密码学操作模式”映射到“ISA 扩展与执行机制”。这张图最重要的价值，是避免工程团队掉进“单指令优化神话”：

- 真正的瓶颈通常在操作链，不在单条指令
- 真正的收益来自结构化压缩，不是局部跑分

## 1. 原图重述

```text
Big-int mul/div chain -> M + MOP
Bit permutation       -> B
Carry-less arithmetic -> B
Atomic handshakes     -> A
```

需要强调：A 在密码学主路径通常不是热点，但在语义完整性上仍有价值。

## 2. secp256k1 路径的现实瓶颈

在验签路径里，常见热点是：

- 大整数乘加与约简链
- 进位传播
- 条件选择与状态搬运

这解释了为什么 `WIDE_MUL/WIDE_DIV/ADD3*` 这类融合操作具有现实价值。

## 3. 哈希路径的现实瓶颈

哈希路径通常表现为：

- rotate/xor/shift 高频出现
- 循环体稳定且重复
- 小块数据访存频繁

因此 B 扩展 + Trace 的组合往往收益更明显。

## 4. MOP 的正确定位

MOP 不是“改 ISA”，而是“在既有语义上做模式融合”。

只有当以下条件都成立时，MOP 才有发布价值：

1. 语义等价可证明
2. 边界行为一致
3. 计费模型可校准

否则它会从优化手段变成分叉风险。

## 5. 计费校准为什么与安全绑定

计费偏差不是体验问题，而是安全问题：

- 低估热点路径 -> DoS 经济窗口
- 高估常用路径 -> 正常用户过度付费

所以优化 PR 必须附“性能报告 + 计费报告 + 等价报告”三件套。

## 6. 常见误判

### 误判 A：微基准提升 = 链上收益提升

实际上，真实 workload 的控制流与数据分布常与微基准不同。

### 误判 B：平均值更快 = 系统更安全

长尾交易和恶意输入通常决定风险上界。

### 误判 C：确定性通过 = 恒时安全通过

两者不是同一个问题。

## 7. 审计清单

1. 是否覆盖 secp/hash/Merkle 三类代表性 workload？
2. MOP 融合是否有前后状态等价报告？
3. cycles 参数是否有版本化校准记录？
4. 是否单独评估侧信道风险？

## 8. 与主文映射

- 对应章节：`第 10 章`
- 关键代码：`src/instructions/b.rs`, `src/decoder.rs`, `src/instructions/execute.rs`, `src/cost_model.rs`
- 关联附录：`附录 A`, `附录 F`, `附录 H/I`

## 9. 一针见血结论

密码学优化最该优化的不是“某条指令”，而是“高频算子链在可验证前提下的整体成本”。

