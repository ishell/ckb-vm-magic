# 第 1 章 共识机器优先：区块链 VM 的第一性原理

## 1.1 核心问题

区块链虚拟机到底是什么？它不是“跑得越快越好”的通用执行器，而是一个共识状态机的一部分。它的首要目标是：

- 同输入下的确定输出
- 可计费的资源消耗
- 可重放的错误与中断路径

## 1.2 图 1-1：共识 VM 的约束层级

```text
+------------------------------+
| 协议约束: 可验证/可回放      |
+------------------------------+
| 经济约束: 可计费/抗 DoS      |
+------------------------------+
| 工程约束: 可维护/可审计      |
+------------------------------+
| 执行优化: Trace/ASM/MOP      |
+------------------------------+
```

关键判断：性能优化位于最底层，必须服从上层约束。

## 1.3 代码证据

`src/machine/mod.rs` 的 `SupportMachine::add_cycles` 直接把“执行动作”和“计费上限”耦合在一起：

- 溢出即 `CyclesOverflow`
- 超上限即 `CyclesExceeded`

`src/error.rs` 将这些状态提升为协议可观察错误，而非日志级事件。

## 1.4 深度分析

传统本地 VM 可以容忍“某些极端路径行为差异”，但共识 VM 不行。只要某个节点在边界条件上产生不同结果，就可能触发分叉。`ckb-vm` 的策略是：

- 先定义不可变语义边界
- 再在边界内做性能优化

这就是为什么它同时强调 `Pause`、`reset_signal`、`cycles`：这些不是运行时“便捷功能”，而是共识控制面。

## 1.5 案例：DoS 防护不是防火墙，而是计费模型

若某条指令链在不同节点上消耗可变、且无上限约束，攻击者可构造输入拖慢部分节点。`ckb-vm` 的 cycles 模型让这种攻击从“技术问题”变成“经济问题”：你可以发起重计算，但必须按协议付费。

## 1.6 术语表（本章）

- `Determinism`：同输入同输出同错误路径。
- `Cycle Budget`：执行预算上限。
- `Consensus Safety`：不因实现差异引发状态分歧。

## 1.7 一针见血结论

区块链 VM 的第一性原理不是吞吐率，而是可证明的一致执行。

## 1.8 反例分析：把“高 TPS”当成唯一目标

反例场景：某 VM 团队只追求吞吐，弱化确定性与计费边界，结果出现两类问题：

- 不同硬件节点在边界输入上出现行为差异，触发共识风险。
- 资源消耗缺乏稳定上限，攻击者可利用低成本构造 DoS 交易。

教训：区块链 VM 的正确目标函数是“确定性 + 可定价 + 可维护”，性能必须在该约束内优化。

## 1.9 架构评审清单（出版版）

- [ ] 是否存在全局一致的 cycles 预算模型与超限错误语义。
- [ ] 是否保证相同输入在不同平台上得到相同输出和错误码。
- [ ] 是否将中断、恢复、失败路径显式纳入状态机。
- [ ] 是否为 DoS 场景建立了经济成本防线（而非仅靠节点配置）。

## 1.10 参考实现清单（代码锚点）

- `src/machine/mod.rs`: `SupportMachine::add_cycles`, `Pause`
- `src/error.rs`: `Error::CyclesExceeded`, `Error::CyclesOverflow`
- `src/cost_model.rs`: `estimate_cycles`（计费模型入口）

## 1.11 术语索引交叉（参见附录 B 与附录 D）

- `Determinism`
- `Cycle Budget`
- `Consensus Safety`


## 1.12 审稿人问题清单（出版评审）

1. 本章是否明确区分了“确定性目标”与“性能目标”的优先级？
2. cycles 上限与错误语义是否被解释为协议约束而非实现细节？
3. 是否给出了至少一个 DoS 经济学层面的反证场景？
4. 论证是否可由 `src/machine/mod.rs` 与 `src/error.rs` 直接验证？
5. “一针见血结论”是否与前文证据严格对应？
6. 本章结论是否对后续章节形成约束关系而非口号？
